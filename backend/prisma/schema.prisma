generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Pages/Files table - stores information about each code file
model Page {
  id            String    @id @default(cuid())
  filePath      String    @unique
  componentName String
  totalLines    Int
  purpose       String
  promptFilePath String?   // Path to the source .txt file
  rawContent    String?   @db.Text // Store the full original text content
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sections      Section[]
  stateVars     StateVar[]
  functions     Function[]
  dependencies  Dependency[] @relation("FromPage")
  dependents    Dependency[] @relation("ToPage")

  @@map("pages")
}

// Sections within a file
model Section {
  id        String   @id @default(cuid())
  pageId    String
  name      String
  startLine Int
  endLine   Int
  purpose   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  page    Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  prompts Prompt[]

  @@map("sections")
}

// Prompts/Modification templates for each section
// promptType: NLP (user-friendly) or DEVELOPER (technical)
model Prompt {
  id           String     @id @default(cuid())
  sectionId    String
  template     String
  example      String?
  description  String?
  lineNumber   Int        @default(0)
  promptType   PromptType @default(NLP)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@map("prompts")
}

// Enum for prompt types
enum PromptType {
  NLP        // User-friendly, natural language prompts
  DEVELOPER  // Technical, concise developer prompts
}

// State variables in a file
model StateVar {
  id          String   @id @default(cuid())
  pageId      String
  name        String
  line        Int
  type        String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("state_vars")
}

// Functions in a file
model Function {
  id         String   @id @default(cuid())
  pageId     String
  name       String
  startLine  Int
  endLine    Int
  purpose    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("functions")
}

// Dependencies between files
model Dependency {
  id           String   @id @default(cuid())
  fromPageId   String
  toPageId     String
  relationship String
  createdAt    DateTime @default(now())

  fromPage Page @relation("FromPage", fields: [fromPageId], references: [id], onDelete: Cascade)
  toPage   Page @relation("ToPage", fields: [toPageId], references: [id], onDelete: Cascade)

  @@map("dependencies")
}

// Master NLP prompt template for a page
model MasterPrompt {
  id              String   @id @default(cuid())
  pageFilePath    String   @unique
  nlpInstruction  String
  sectionsSummary String
  queryExamples   String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("master_prompts")
}

// User model for authentication
model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  role      String    @default("user")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  projects  Project[]

  @@map("users")
}

// Project model for multi-project support
model Project {
  id          String   @id @default(cuid())
  name        String
  path        String
  description String?
  isActive    Boolean  @default(false)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, path])
  @@map("projects")
}
